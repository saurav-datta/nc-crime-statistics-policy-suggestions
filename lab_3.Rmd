---
title: "W203: Lab 3"
author: "Deepak Nagaraj"
date: "3/19/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## About the dataset:
* A selection of counties in North Carolina
* Original: Cornwell and Trumball (1994)

## What to do:
* Understand determinants of crime
* Generate policy suggestions applicable to local government
* Provide research for a political campaign

## What to do for Week 1:
* Identify variables of interest
* Any transformations for each variable?
* Support from EDA?
* What covariates can identify causal effect?  Which ones are problematic (multicollinearity or dampening)
* Produce 3 models:
    - One model with only explanatory variables of key interest (and no covariates)
    - Above, plus covariates that increase accuracy without introducing bias
    - Above, plus most other covariates
* Regression table, via stargazer
* Discussion of 5-10 omitted variables, for each: how it affects

## How to do:
* Use OLS regression
* Omitted variables will be a major obstacle
* Aim for causal estimates, clearly explaining how omitted variables may affect conclusions

## Reading the data

Let us first read the data.

```{r}
library(dplyr)
crime0 = read.csv("crime_v2.csv")
colnames(crime0)
# Commented for conciseness
# structure(crime0)

# prbconv is a factor: convert to float instead
# commented for conciseness
# levels(crime0$prbconv)
crime0$prbconv = as.numeric(levels(crime0$prbconv))[crime0$prbconv]

# FIXME: is it better to replace with NA instead of removing the data?
crime = crime0 %>% 
  filter(prbconv <= 1.0) %>% 
  filter(prbarr <= 1.0) %>% 
  filter(prbpris <= 1.0) %>% 
  filter(!(west == 1 & central == 1)) %>%
  select(-year)
# Commented for conciseness
# structure(crime)
```

Our dependent variable is going to be $crmrte$.  We want to come up with a model that can predict crime rate.

The following columns are interesting:

* county: county number
* prbarr: Probability of arrest (ratio: arrest/offense)
* prbconv: Probability of conviction (ratio: conviction/arrest)
* prbpris: Probability of prison sentence (ratio: prison/total convictions)
* avgsen: Average sentence in days
* polpc: Police per capita
* density: People per square mile
* taxpc: Tax revenue per capita
* west/central/urban: Geographical location
* pctmin80: % minority (1980)
* wcon/wtuc/wtrd/wfir/wser/wmfg/wfed/wsta/wloc: Weekly wages across sectors
* mix: Offense mix: face-to-face/other
* pctymle: % young male

Possible collinearity pairs we should check for:

* urban and density
* prbarr, prbconv, prbpris
* wages across sectors

Anything else?

Interesting causal questions:

* Can low probabilities of arrest, conviction, or sentence drive high crime rate?  Answer: Yes (for arrest)
* Can low sentencing period cause high crime rate?  Answer: No
* Can fewer police per capita cause high crime rate?
* Can very high or very low density cause crime?
* Can lower tax revenue cause crime?
* Can geographical location cause crime?
* Is crime higher in urban areas, certain counties?
* Can high % of young males drive crime?
* Can low wages cause crime?
* Can high numbers of minorities cause crime, esp hate crime?

## County and crime rate

Crime seems to be uniformly distributed across the counties.

```{r}
hist(crime$county)
```

## Arrests and crime rate

We see arrests and conviction driving down crime rate:

```{r}
par(mfrow = c(1, 2))

plot(crime$prbarr, crime$crmrte, xlim=c(0,1.0))
m = lm(crime$crmrte ~ crime$prbarr)
abline(m)

plot(crime$prbconv, crime$crmrte, xlim=c(0,1.0))
m = lm(crime$crmrte ~ crime$prbconv)
abline(m)
```

Policy recommendation: enable infrastructure to allow for catching of criminals.

TODO: Check for multicollinearity in the arrest, conviction and prison rates.

## Prison sentence and crime rate

However, not much effect based on whether prison sentence happened and how long the sentence was.

```{r}
par(mfrow = c(1, 2))

plot(crime$prbpris, crime$crmrte)
m = lm(crime$crmrte ~ crime$prbpris)
abline(m)

plot(crime$avgsen, crime$crmrte)
m = lm(crime$crmrte ~ crime$avgsen)
abline(m)
```

Policy recommendation: Probability of prison sentence does not affect crime rate much; it is higher where average sentences are high.

## Police and crime rate

We see higher police per capita associated with higher crime rate.  This could be because we are deploying more police in higher crime areas (effect, not cause) or perhaps the additional police are not being effective enough in deterring crime.

```{r}
par(mfrow = c(1, 2))

plot(crime$polpc, crime$crmrte)
m = lm(crime$crmrte ~ crime$polpc)
abline(m)

plot(m, which=5)
```

The residuals graph shows that row 72 has a lot of leverage, but it still falls short of Cook's distance of 1.  So we will keep it as-is.  Let us look at the row though.  We can also drop the row and see how the graph changes.

```{r}
crime %>% slice(71) %>% select(everything())

par(mfrow = c(1, 2))

plot(crime$polpc, crime$crmrte, xlim=c(0,0.004))
m = lm(crime$crmrte ~ crime$polpc)
abline(m)

# TODO: Check what's special in rows 71, 5, 23
crime2 = crime %>% slice(-71) %>% slice(-5) %>% slice(-22)
plot(crime2$polpc, crime2$crmrte, xlim=c(0,0.004))
m = lm(crime2$crmrte ~ crime2$polpc)
abline(m)
```

The graph has a higher slope if we remove the outliers.

Policy recommendation: increase effectiveness of police.

## Density

Let us check if population density affects crime.

```{r}
plot(crime$density, crime$crmrte)
m = lm(crime$crmrte ~ crime$density)
abline(m)
```

It looks like crime rate goes up with density, although data is sparse at higher densities.

### Tax revenue

How does tax revenue per capita affect crime rate?

```{r}
plot(crime$taxpc, crime$crmrte)
m = lm(crime$crmrte ~ crime$taxpc)
abline(m)
```

We see that crime rate goes up as tax revenue per capita goes up.  This could be because higher tax revenue implies higher income and therefore higher chance for theft or burglary.

### Geographic location
```{r}
par(mfrow = c(1, 3))

crime_west = crime %>% filter(west == 1)
crime_central = crime %>% filter(central == 1)
crime_rest = crime %>% filter(west == 0 & central == 0)
boxplot(crime_west$crmrte, main="Crime: West", ylim=c(0,0.10))
boxplot(crime_central$crmrte, main="Crime: Central", ylim=c(0,0.10))
boxplot(crime_rest$crmrte, main="Crime: Rest", ylim=c(0,0.10))
```

Crime rate is higher in the central region, with one clear outlier (1 in 10).  But crime range is higher in the remaining regions.

### Urban vs rural

Is crime rate higher in urban or rural areas?

```{r}
par(mfrow = c(1, 2))

crime_urban = crime %>% filter(urban == 1)
crime_rural = crime %>% filter(urban == 0)
boxplot(crime_urban$crmrte, main="Crime: Urban", ylim=c(0,0.10))
boxplot(crime_rural$crmrte, main="Crime: Rural", ylim=c(0,0.10))
```

Clearly, crime rate is higher in urban areas.  We need to focus on urban areas.

### Minorities

```{r}
plot(crime$pctmin80, crime$crmrte)
m = lm(crime$crmrte ~ crime$pctmin80)
abline(m)
```

As minorities go up, we see a slight increase in crime rate.

### Offense mix

Let's see how mix affects crime rate.

```{r}
plot(crime$mix, crime$crmrte)
m = lm(crime$crmrte ~ crime$mix)
abline(m)
```

We see that high crime rates are correlated with low crime mix: i.e. these crimes do not involve face-to-face interaction.

### Young males

```{r}
par(mfrow = c(1, 2))

plot(crime$pctymle, crime$crmrte)
m = lm(crime$crmrte ~ crime$pctymle)
abline(m)

plot(m, which=5)
```

We see that crime rate goes up as we have higher percentage of young males.  Row 53 is an outlier with large Cook's distance.  Let us have a look at it.  This is county 133, which has 5.5% crime rate and 25% young male population.

```{r}
crime %>% slice(53) %>% select(everything())
```

Let us remove this data and try again:

```{r}
par(mfrow = c(1, 2))

plot(crime$pctymle, crime$crmrte, xlim=c(0,0.26))
m = lm(crime$crmrte ~ crime$pctymle)
abline(m)

crime_no53 = crime %>% slice(-53)
plot(crime_no53$pctymle, crime_no53$crmrte, xlim=c(0,0.26))
m = lm(crime_no53$crmrte ~ crime_no53$pctymle)
abline(m)
```

There is a marked increase in slope.  However, we have a wide band of crime rate in the 6-12% young male range.  Our $R^2$ is only 9%.

```{r}
summary(m)
```

## Wages and crime rate

As wage goes up, crime seems to go up.

```{r}
par(mfrow = c(3, 3))
m = lm(crime$crmrte ~ crime$wcon, data=crime)
plot(crime$wcon, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wfed, data=crime)
plot(crime$wfed, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wfir, data=crime)
plot(crime$wfir, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wloc, data=crime)
plot(crime$wloc, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wmfg, data=crime)
plot(crime$wmfg, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wser, data=crime)
plot(crime$wser, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wsta, data=crime)
plot(crime$wsta, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wtrd, data=crime)
plot(crime$wtrd, crime$crmrte)
abline(m)

m = lm(crime$crmrte ~ crime$wtuc, data=crime)
plot(crime$wtuc, crime$crmrte)
abline(m)
```

### Checking for collinearity

Let us look for pairs of variables with high correlation.

```{r}
# Build the matrix
crime_cor_matrix <- round(cor(crime), 2)
# It is symmetric
crime_cor_matrix[upper.tri(crime_cor_matrix, diag=TRUE)] <- NA
crime_cor_df <- as.data.frame(as.table(crime_cor_matrix))
# Select pairs with high correlation
crime_cor_df %>% 
  filter(abs(Freq) >= 0.66) %>% 
  arrange(desc(Freq)) %>% 
  select(everything()) 
```

We see that $urban$ and $density$ have high correlation, so we can use one instead of both.  There is also high correlation between wages in finance and investments $wfir$ vs. trade and retail $wtrd$.  We can keep one instead of the other.

### Selecting variables based on statistical significance

First, we will simply try to fit all the independent variables and then remove those that do not add a lot of statistical significance.

```{r}
# Source: https://www.youtube.com/watch?v=I4z3yjoEADY
m <- lm(crime$crmrte ~ ., crime)
summary(m)
```

The default model has an $R^2$ value of 0.85.

We see that the following variables are significant (p < 0.1):

* prbarr
* avgsen
* polpc
* density
* central
* pctmin80
* wser
* wsta
* pctymle

Let us try to build a newer model with the above (fewer) variables.

```{r}
m <- lm(crime$crmrte ~ prbarr + avgsen + polpc + 
          density + central + pctmin80 + wser + wsta + pctymle,
        crime)
cor(crime$pctymle, crime$crmrte)
summary(m)
```

Our $R^2$ is still 0.8, which is quite significant.

Let us analyze the independent variables for causality.

* prbarr: it is plausible that we have more arrests in areas with high crime (effect, not cause)
* avgsen: Same reasoning can hold for average sentence: high crime rate can result in higher average sentences
* polpc: It is possible that high number of police per capita is a result of high crime rate, not a cause
* density: Density sounds like a possible cause: higher population density means higher opportunity for anonymity and lower probability of detection
* central: Central NC has higher crime rate but this could be due to omitted variables such as higher density or urban population
* pctmin80: Higher percentage of minorities can indicate social tension and anonymity, causing higher crime rate.
* wser, wsta: Wages in services and state is not causal: it is probably due to omitted variables.  These wages are probably higher in urban areas due to higher minimum wage.
* pctymle: % young male is probably causal.  Young men are known to engage in risky, aggressive behavior that correlates well with crime rate.

So our causal variables can be:
* density
* pctmin80
* pctymle

Let us fit the model:

```{r}
m <- lm(crime$crmrte ~ density + pctmin80 + pctymle,
        crime)
summary(m)
```

The $R^2$ is still 0.6, which is quite high for only three predictors.

Possible policy suggestions:

* Are we arresting criminals?
* Are we convicting too much or too little?
* Should we increase police presence?
* Is higher tax revenue going to cut down on crime?
* How is crime spread across West, Central and urban NC?
* How is crime correlated with % minority?
* Are low wages driving crime?
* Is there hate crime in the area ("mix"), and is it correlated with % minority?
* How is crime connected to % young male?

